services:
  neo4j:
    image: docker.arvancloud.ir/neo4j:2025.07.1
    container_name: neo4j
    restart: unless-stopped
    environment:
      # Authentication
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      
      # HTTP Configuration (Public-facing)
      - NEO4J_server_http_listen__address=0.0.0.0:7474
      - NEO4J_server_http_advertised__address=185.130.79.32:7474
      
      # Bolt Configuration (Internal Docker network + Public)
      - NEO4J_server_bolt_listen__address=0.0.0.0:7687
      - NEO4J_server_bolt_advertised__address=185.130.79.32:7687
      
      # HTTPS Configuration (Recommended for production)
      - NEO4J_server_https_enabled=true
      - NEO4J_server_https_listen__address=0.0.0.0:7473
      - NEO4J_server_https_advertised__address=185.130.79.32:7473
      
      # Memory Optimization (برای سرور 2GB+ RAM)
      - NEO4J_server_memory_pagecache_size=1G
      - NEO4J_server_memory_heap_initial__size=512M
      - NEO4J_server_memory_heap_max__size=1G
      
      # Security Hardening
      - NEO4J_dbms_security_auth__force__username__validation=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*,n10s.*
      - NEO4J_dbms_security_http__auth__allow__no__auth=false
      
      # APOC & Import/Export (برای پردازش داده‌های حجیم)
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      
      # Logging
      - NEO4J_dbms_logs_debug_level=INFO
      
      # SEPSes Ontology Support (Neosemantics plugin)
      - NEO4JLABS_PLUGINS=["apoc", "graph-data-science", "neosemantics"]
    
    ports:
      - "7474:7474"   # HTTP Browser (Public)
      - "7473:7473"   # HTTPS Browser (Public)
      - "7687:7687"   # Bolt Protocol (Public + Internal)
    
    volumes:
      - /opt/neo4j_gai/data:/data          # Persistent graph data
      - /opt/neo4j_gai/logs:/logs          # Query & security logs
      - /opt/neo4j_gai/import:/import      # CSV/JSON imports
      - /opt/neo4j_gai/plugins:/plugins    # Custom plugins (APOC, GDS)
      - /opt/neo4j_gai/config:/config      # Custom neo4j.conf
    
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "Admin", "--format", "verbose", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    
    networks:
      - neo4j-network

  neodash:
    image: docker.arvancloud.ir/neo4j-labs/neodash:2.4.0
    container_name: neodash
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE}
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - neo4j-network

  mcp-server-neo4j:
    image: docker.arvancloud.ir/neo4j-labs/mcp-server-neo4j:latest
    container_name: mcp-server-neo4j
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE}
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - neo4j-network

networks:
  neo4j-network:
    driver: bridge
    name: neo4j-internal-network