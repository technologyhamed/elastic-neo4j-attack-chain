GET /.internal.alerts-security.alerts-default-*/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "range": {
            "@timestamp": {
              "gte": "now/y",
              "lte": "now"
            }
          }
        },
        {
          "exists": {
            "field": "kibana.alert.ancestors.id"
          }
        }
      ]
    }
  },
  "aggs": {
    "attack_chains": {
      "terms": {
        "field": "kibana.alert.ancestors.id",
        "size": 2
      },
      "aggs": {
        "alerts_in_chain": {
          "top_hits": {
            "size": 2,
            "sort": [
              {
                "@timestamp": {
                  "order": "desc"
                }
              }
            ],
            "_source": {
              "includes": [
                "@timestamp",
                "source.ip",
                "source.port",
                "destination.ip",
                "destination.port",
                "host",
                "user",
                "process",
                "file",
                "kibana.alert.severity",
                "kibana.alert.risk_score",
                "kibana.alert.rule.name",
                "kibana.alert.rule.threat",
                "kibana.alert.ancestors"
              ]
            }
          }
        }
      }
    }
  }
}
